rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidEmail() {
      return isAuthenticated() && request.auth.token.email_verified == true;
    }
    
    // Rate limiting helper - checks if enough time has passed since last action
    function notTooFrequent(seconds) {
      return !exists(/databases/$(database)/documents/users/$(request.auth.uid)/rateLimits/lastRequest)
        || get(/databases/$(database)/documents/users/$(request.auth.uid)/rateLimits/lastRequest).data.timestamp < request.time - duration.value(seconds, 's');
    }
    
    // Validate string length
    function validStringLength(str, minLen, maxLen) {
      return str.size() >= minLen && str.size() <= maxLen;
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      allow read: if isOwner(userId);
      
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.keys().hasAll(['email', 'name', 'createdAt', 'updatedAt'])
        && request.resource.data.email == request.auth.token.email
        && validStringLength(request.resource.data.name, 2, 100);
      
      allow update: if isOwner(userId)
        && request.resource.data.diff(resource.data).affectedKeys()
           .hasOnly(['name', 'studentId', 'university', 'department', 'year', 'updatedAt'])
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['name']) 
           || validStringLength(request.resource.data.name, 2, 100));
      
      allow delete: if isOwner(userId);
      
      // Rate limiting subcollection
      match /rateLimits/{doc} {
        allow read, write: if isOwner(userId);
      }
    }
    
    // ============================================
    // COURSES COLLECTION
    // ============================================
    match /courses/{courseId} {
      allow read: if isOwner(resource.data.userId);
      
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'code', 'name', 'createdAt', 'updatedAt'])
        && validStringLength(request.resource.data.code, 2, 20)
        && validStringLength(request.resource.data.name, 2, 100)
        && (!request.resource.data.keys().hasAny(['difficulty']) 
           || request.resource.data.difficulty in [1, 2, 3, 4, 5]);
      
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['name']) 
           || validStringLength(request.resource.data.name, 2, 100));
      
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // TASKS COLLECTION
    // ============================================
    match /tasks/{taskId} {
      allow read: if isOwner(resource.data.userId);
      
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'courseId', 'title', 'type', 'priority', 'status', 'dueDate', 'createdAt', 'updatedAt'])
        && validStringLength(request.resource.data.title, 3, 100)
        && request.resource.data.type in ['assignment', 'exam', 'quiz', 'project', 'study', 'other']
        && request.resource.data.priority in ['low', 'medium', 'high', 'urgent']
        && request.resource.data.status in ['todo', 'in_progress', 'completed', 'overdue']
        && (!request.resource.data.keys().hasAny(['estimatedHours']) 
           || (request.resource.data.estimatedHours >= 0 && request.resource.data.estimatedHours <= 1000))
        && (!request.resource.data.keys().hasAny(['description']) 
           || validStringLength(request.resource.data.description, 0, 5000));
      
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId
        && (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['title']) 
           || validStringLength(request.resource.data.title, 3, 100));
      
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // TIMETABLE ENTRIES
    // ============================================
    match /timetableEntries/{entryId} {
      allow read: if isOwner(resource.data.userId);
      
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'courseId', 'dayOfWeek', 'startTime', 'endTime', 'createdAt'])
        && request.resource.data.dayOfWeek >= 0
        && request.resource.data.dayOfWeek <= 6
        && request.resource.data.startTime.matches('^([0-1][0-9]|2[0-3]):[0-5][0-9]$')
        && request.resource.data.endTime.matches('^([0-1][0-9]|2[0-3]):[0-5][0-9]$');
      
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId;
      
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // STUDY SESSIONS
    // ============================================
    match /studySessions/{sessionId} {
      allow read: if isOwner(resource.data.userId);
      
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'courseId', 'duration', 'date', 'createdAt'])
        && request.resource.data.duration > 0
        && request.resource.data.duration <= 1440
        && (!request.resource.data.keys().hasAny(['effectiveness']) 
           || request.resource.data.effectiveness in [1, 2, 3, 4, 5])
        && (!request.resource.data.keys().hasAny(['notes']) 
           || validStringLength(request.resource.data.notes, 0, 5000));
      
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId;
      
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // CHAT MESSAGES (with rate limiting)
    // ============================================
    match /chatMessages/{messageId} {
      allow read: if isOwner(resource.data.userId);
      
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'text', 'isUserMessage', 'timestamp'])
        && validStringLength(request.resource.data.text, 1, 5000)
        && notTooFrequent(2); // Rate limit: max 1 message per 2 seconds
      
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // CHAT SESSIONS
    // ============================================
    match /chatSessions/{chatId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // STUDY PLANS
    // ============================================
    match /studyPlans/{planId} {
      allow read: if isOwner(resource.data.userId);
      
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'startDate', 'endDate', 'generatedAt', 'aiGenerated']);
      
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.userId == resource.data.userId;
      
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // STUDY PLAN ENTRIES
    // ============================================
    match /studyPlanEntries/{entryId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // ============================================
    // NOTIFICATIONS
    // ============================================
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId);
      
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.keys().hasAll(['userId', 'title', 'body', 'type', 'read', 'createdAt'])
        && validStringLength(request.resource.data.title, 1, 100)
        && validStringLength(request.resource.data.body, 1, 500)
        && request.resource.data.type in ['deadline', 'study_reminder', 'achievement', 'warning'];
      
      allow update: if isOwner(resource.data.userId)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['read']);
      
      allow delete: if isOwner(resource.data.userId);
    }
    
    // ============================================
    // DEFAULT DENY - Security by default
    // ============================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

